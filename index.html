import { useState, useEffect, useRef } from 'react';

// Componente freccia SVG per lo scroll
const ChevronDown = ({ className }: { className?: string }) => (
  <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="6 9 12 15 18 9"></polyline>
  </svg>
);

// Componente sigillo di cera
const WaxSeal = () => (
  <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style={{width:'100%',height:'100%'}}>
    <defs>
      <radialGradient id="wg" cx="36%" cy="32%" r="62%">
        <stop offset="0%" stopColor="#d4977e"/>
        <stop offset="45%" stopColor="#8b5e4a"/>
        <stop offset="100%" stopColor="#4e2416"/>
      </radialGradient>
      <filter id="wf" x="-15%" y="-15%" width="130%" height="130%">
        <feTurbulence type="fractalNoise" baseFrequency="0.035" numOctaves="4" seed="8" result="noise"/>
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="5" xChannelSelector="R" yChannelSelector="G"/>
      </filter>
    </defs>
    <circle cx="50" cy="50" r="44" fill="url(#wg)" filter="url(#wf)"/>
    <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(255,255,255,0.16)" strokeWidth="1.2"/>
    <circle cx="50" cy="50" r="38" fill="none" stroke="rgba(0,0,0,0.2)" strokeWidth="0.8"/>
    <text x="50" y="57"
      fontFamily="Dancing Script, cursive"
      fontSize="21" fontWeight="700"
      textAnchor="middle"
      fill="rgba(255,255,255,0.9)"
      style={{filter:'drop-shadow(0 1px 2px rgba(0,0,0,0.5))'}}>S&amp;S</text>
    <ellipse cx="37" cy="33" rx="11" ry="7" fill="rgba(255,255,255,0.14)" transform="rotate(-25,37,33)"/>
    <ellipse cx="62" cy="66" rx="5" ry="3" fill="rgba(0,0,0,0.12)" transform="rotate(-25,62,66)"/>
  </svg>
);

export function App() {
  const [phase, setPhase] = useState<'idle' | 'opening' | 'done'>('idle');
  const [envelopeOpen, setEnvelopeOpen] = useState(false);
  const [letterFloating, setLetterFloating] = useState(false);
  const [letterFarewell, setLetterFarewell] = useState(false);
  const [envelopeSinking, setEnvelopeSinking] = useState(false);
  const [envelopeStyle, setEnvelopeStyle] = useState<React.CSSProperties>({});
  const [letterStyle, setLetterStyle] = useState<React.CSSProperties>({});
  const [overlayClass, setOverlayClass] = useState('');
  const [mainVisible, setMainVisible] = useState(false);
  const [heroBgLoaded, setHeroBgLoaded] = useState(false);
  const [sceneHidden, setSceneHidden] = useState(false);
  const [hintVisible, setHintVisible] = useState(true);
  
  const heroBgRef = useRef<HTMLDivElement>(null);
  const detailsRef = useRef<HTMLElement>(null);

  // Parallax effect on scroll
  useEffect(() => {
    const handleScroll = () => {
      if (phase !== 'done' || !heroBgRef.current) return;
      heroBgRef.current.style.transform = `scale(1) translateY(${window.pageYOffset * 0.28}px)`;
    };
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, [phase]);

  // Handle body overflow
  useEffect(() => {
    if (mainVisible) {
      document.body.classList.add('revealed');
    }
  }, [mainVisible]);

  const handleEnvelopeClick = () => {
    if (phase !== 'idle') return;
    setPhase('opening');
    setHintVisible(false);

    // t = 0s - Apri la busta
    setEnvelopeOpen(true);

    // t = 1.9s - Lettera fluttua
    setTimeout(() => setLetterFloating(true), 1900);

    // t = 2.1s - Busta scende
    setTimeout(() => {
      setEnvelopeSinking(true);
      setEnvelopeStyle({
        transform: 'translateY(140px) rotateX(12deg) scale(0.88)',
        opacity: 0.3
      });
    }, 2100);

    // t = 3.8s - Lettera sale e sfuma
    setTimeout(() => {
      setLetterFloating(false);
      setLetterFarewell(true);
      setLetterStyle({ opacity: 0 });
    }, 3800);

    // t = 3.7s - Busta sfuma
    setTimeout(() => {
      setEnvelopeStyle(prev => ({ ...prev, opacity: 0 }));
    }, 3700);

    // t = 3.8s - Flash bianco
    setTimeout(() => setOverlayClass('flash'), 3800);

    // t = 4.25s - Sito visibile
    setTimeout(() => {
      setMainVisible(true);
      setHeroBgLoaded(true);
    }, 4250);

    // t = 4.6s - Flash sfuma
    setTimeout(() => setOverlayClass('unflash'), 4600);

    // t = 5s - Pulizia finale
    setTimeout(() => {
      setSceneHidden(true);
      setPhase('done');
    }, 5000);
  };

  const scrollToDetails = () => {
    detailsRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const envelopeClasses = `envelope ${envelopeOpen ? 'open' : ''} ${envelopeSinking ? 'sinking' : ''}`;
  const letterWrapClasses = `letter-wrap ${letterFloating ? 'floating' : ''} ${letterFarewell ? 'farewell' : ''}`;

  return (
    <>
      <div className={`transition-overlay ${overlayClass}`} />

      {/* PAGE 1 ‚Äî ENVELOPE */}
      {!sceneHidden && (
        <div className="scene">
          <div className="env-stage">
            <div 
              className={envelopeClasses} 
              onClick={handleEnvelopeClick}
              style={envelopeStyle}
            >
              {/* Body */}
              <div className="env-body">
                <div className="env-lining" />
                <div className="env-interior" />
                <div className="env-left" />
                <div className="env-right" />
                <div className="env-bottom" />
              </div>

              {/* Corner masks */}
              <div className="env-corner-left" />
              <div className="env-corner-right" />

              {/* Top flap */}
              <div className="env-flap">
                <div className="env-flap-front" />
                <div className="env-flap-back" />
              </div>

              {/* Wax seal */}
              <div className="wax-seal">
                <WaxSeal />
              </div>

              {/* Letter */}
              <div className="letter-outer">
                <div className={letterWrapClasses} style={letterStyle}>
                  <div className="letter-card">
                    <p className="letter-ornament">Con gioia nel cuore</p>
                    <div className="letter-divider" />
                    <h1 className="letter-names">Sara &amp; Stefano</h1>
                    <div className="letter-divider" />
                    <p className="letter-date">15 ¬∑ Giugno ¬∑ 2025</p>
                  </div>
                </div>
              </div>
            </div>

            <div 
              className="open-hint" 
              style={{ opacity: hintVisible ? undefined : 0, pointerEvents: hintVisible ? undefined : 'none' }}
            >
              Clicca per aprire
            </div>
          </div>
        </div>
      )}

      {/* PAGE 2 ‚Äî MAIN SITE */}
      <div className={`main-content ${mainVisible ? 'visible' : ''}`}>
        <section className="hero">
          <div 
            ref={heroBgRef}
            className={`hero-bg ${heroBgLoaded ? 'loaded' : ''}`} 
          />
          <div className="hero-overlay" />
          
          <div 
            className="relative z-[2] text-center text-white p-8"
            style={{ animation: mainVisible ? 'fadeUp 1.2s ease both' : 'none' }}
          >
            <p className="text-xs tracking-[6px] uppercase text-white/55 mb-3">
              Il nostro matrimonio
            </p>
            <h1 
              className="font-['Dancing_Script',cursive] leading-none mb-1"
              style={{ 
                fontSize: 'clamp(3.5rem, 10vw, 6.5rem)',
                textShadow: '0 2px 30px rgba(0,0,0,0.38)'
              }}
            >
              Sara &amp; Stefano
            </h1>
            <div className="flex items-center justify-center gap-4 my-4 text-white/40 text-xs">
              <span className="flex-1 max-w-[80px] h-px bg-white/30" />
              <span>‚ùß</span>
              <span className="flex-1 max-w-[80px] h-px bg-white/30" />
            </div>
            <p 
              className="font-['Playfair_Display',serif] tracking-[5px] uppercase text-white/70 mb-5"
              style={{ fontSize: 'clamp(0.85rem, 2.2vw, 1.15rem)' }}
            >
              15 Giugno 2025
            </p>
            <p 
              className="font-['Cormorant_Garamond',serif] italic text-white/70 max-w-[500px] mx-auto leading-relaxed"
              style={{ fontSize: 'clamp(1rem, 2.5vw, 1.25rem)' }}
            >
              Con gioia nel cuore, vi invitiamo a condividere con noi il giorno pi√π bello della nostra vita.
            </p>

            {/* Pulsante rimosso - manteniamo solo la freccia sotto */}
          </div>

          {/* NUOVO: Indicatore scroll pi√π visibile */}
          <div className="scroll-indicator" onClick={scrollToDetails}>
            <span className="scroll-text">Scorri per i dettagli</span>
            <div className="scroll-arrow-container">
              <ChevronDown className="scroll-arrow" />
              <ChevronDown className="scroll-arrow" />
              <ChevronDown className="scroll-arrow" />
            </div>
          </div>
        </section>

        <section ref={detailsRef} className="details-section" id="dettagli">
          <p className="section-eyebrow">La nostra giornata</p>
          <h2 className="section-title">I dettagli</h2>
          <div className="details-grid">
            <a 
              className="detail-card" 
              href="https://maps.app.goo.gl/h35iSmGDXWYMYuZQA" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              <span className="detail-icon">‚õ™</span>
              <h3 className="detail-title">Cerimonia</h3>
              <p className="detail-text">
                Chiesa di San Pietro<br/>
                Via Roma, 123<br/>
                Ore 15:00
              </p>
              <p className="detail-note">La cerimonia sar√† celebrata da Don Mario Rossi.</p>
            </a>
            <a 
              className="detail-card" 
              href="https://maps.app.goo.gl/FYA6hYuA2w6UgFcr7" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              <span className="detail-icon">üçæ</span>
              <h3 className="detail-title">Ricevimento</h3>
              <p className="detail-text">
                Villa Bellini<br/>
                Via dei Fiori, 45<br/>
                Dopo la cerimonia
              </p>
              <p className="detail-note">Cena, balli e festeggiamenti in una splendida villa rinascimentale.</p>
            </a>
            <a 
              className="detail-card" 
              href="https://stefanotassinari97-hash.github.io/Prova_matrimonio_2.github.io/" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              <span className="detail-icon">üéÅ</span>
              <h3 className="detail-title">Lista Nozze</h3>
              <p className="detail-text">
                La vostra presenza √® il regalo pi√π bello.<br/>
                Se desiderate farci un dono, clicca qui.
              </p>
              <p className="detail-note">Contattate i nostri testimoni per informazioni.</p>
            </a>
          </div>
        </section>

        <footer className="footer">
          <div className="footer-names">Sara &amp; Stefano</div>
          <p className="footer-text">Con amore</p>
          <div className="footer-hearts">‚ô• ‚ô• ‚ô•</div>
          <p className="footer-info">15 Giugno 2025 ¬∑ Villa Bellini</p>
          <p className="footer-info">+39 333 123 4567 ¬∑ info@saraestefano.it</p>
        </footer>
      </div>
    </>
  );
}
